\nimport React, { useState, useEffect, useContext, useCallback } from \\\'react\\\';\nimport { Card } from \\\'../components/Card\\\';\nimport { Button } from \\\'../components/Button\\\';\nimport { Input } from \\\'../components/Input\\\';\nimport { Toggle } from \\\'../components/Toggle\\\';\nimport { Icons } from \\\'../components/icons\\\';\nimport { ToastContext, ToastContextType } from \\\'../context/ToastContext\\\';\nimport { useSound } from \\\'../context/SoundContext\\\';\nimport { ChangePasswordModal } from \\\'../components/ChangePasswordModal\\\';\nimport { DeleteAccountModal } from \\\'../components/DeleteAccountModal\\\';\n\n// Define the structure of the settings object\ninterface UserSettings {\n    mfaActive: boolean;\n    highSecLogs: boolean;\n    geoMonitor: boolean;\n    autoTerminate: boolean;\n    hardLock: boolean;\n    anonymizedAnalytics: boolean;\n    affiliateTracking: boolean;\n    contributionDisplay: boolean;\n    aestheticMode: \\\'dark\\\' | \\\'light\\\';\n    dataViewFormat: \\\'decimal\\\' | \\\'percentage\\\';\n    language: string;\n    audioMuted: boolean;\n    emailIntel: boolean;\n    communitySignal: boolean;\n    marketingComm: boolean;\n}\n\nexport const SettingsPage = () => {\n    const toastCtx = useContext(ToastContext) as ToastContextType | undefined;\n    const showToast = toastCtx?.showToast ?? (() => {});\n    const { setMuted } = useSound();\n\n    const [user, setUser] = useState<{ handle: string; email: string } | null>(null);\n    const [settings, setSettings] = useState<UserSettings | null>(null);\n    const [newHandle, setNewHandle] = useState(\\\'\\\');\n    const [isPasswordModalOpen, setPasswordModalOpen] = useState(false);\n    const [isDeleteModalOpen, setDeleteModalOpen] = useState(false);\n    const [isLoading, setIsLoading] = useState(true);\n\n    // Fetch all user data\n    useEffect(() => {\n        const fetchUserData = async () => {\n            setIsLoading(true);\n            try {\n                const jwt = localStorage.getItem(\\\'jwt\\\');\n                if (!jwt) throw new Error(\\\'AUTHENTICATION INVALID\\\');\n\n                const response = await fetch(\\\'http://localhost:3001/user\\\', { headers: { \\\'x-appwrite-jwt\\\': jwt } });\n                if (!response.ok) throw new Error(\\\'Failed to fetch user data\\\');\n                \n                const data = await response.json();\n                setUser({ handle: data.user.name, email: data.user.email });\n                setNewHandle(data.user.name);\n                setSettings(data.settings);\n                setMuted(data.settings.audioMuted); // Sync sound context\n\n            } catch (error: any) {\n                showToast(error.message, \\\'error\\\');\n            } finally {\n                setIsLoading(false);\n            }\n        };\n        fetchUserData();\n    }, [showToast, setMuted]);\n\n    // Generic handler to update a single setting\n    const handleSettingChange = useCallback(async (key: keyof UserSettings, value: any) => {\n        if (!settings) return;\n        \n        const originalValue = settings[key];\n        setSettings(prev => prev ? { ...prev, [key]: value } : null);\n\n        try {\n            const jwt = localStorage.getItem(\\\'jwt\\\');\n            const response = await fetch(\\\'http://localhost:3001/user/settings\\\', {\n                method: \\\'POST\\\',\n                headers: { \\\'Content-Type\\\': \\\'application/json\\\', \\\'x-appwrite-jwt\\\': jwt || \\\'\\\' },\n                body: JSON.stringify({ [key]: value })\n            });\n            if (!response.ok) throw new Error(); // Let catch block handle it\n            \n            showToast(\`Setting \\\${key} updated.\`, \\\'success\\\');\n        } catch (error) {\n            showToast(\`Failed to update \\\${key}. Reverting.\`, \\\'error\\\');\n            setSettings(prev => prev ? { ...prev, [key]: originalValue } : null); // Revert on failure\n        }\n    }, [settings, showToast]);\n\n    // Specific handler for sound toggle to avoid double toast\n    const handleAudioToggle = (isSoundOn: boolean) => {\n        handleSettingChange(\\\'audioMuted\\\', !isSoundOn);\n        setMuted(!isSoundOn);\n    };\n\n    // ... (handleUpdateUsername, handleDeleteAccount remain the same)\n\n    if (isLoading) {\n        return <div className=\\\"text-center p-20 font-mono text-[#00FFC0]\\\">// LOADING COMMAND CONSOLE...</div>;\n    }\n\n    if (!user || !settings) {\n        return <div className=\\\"text-center p-20 font-mono text-red-500\\\">// FAILED TO LOAD USER DATA. PLEASE RELOG.</div>;\n    }\n\n    // The rest of the JSX uses the `settings` state and `handleSettingChange` handler\n    // For example:\n    // <Toggle checked={settings.highSecLogs} onChange={(checked) => handleSettingChange(\\\'highSecLogs\\\', checked)} ... />\n    // <select value={settings.language} onChange={(e) => handleSettingChange(\\\'language\\\', e.target.value)} ... />\n    \n    return (\n        <>\n            <ChangePasswordModal isOpen={isPasswordModalOpen} onClose={() => setPasswordModalOpen(false)} showToast={showToast} />\n            <DeleteAccountModal isOpen={isDeleteModalOpen} onClose={() => setDeleteModalOpen(false)} onConfirm={async (password) => { /* ... */ }} showToast={showToast} />\n            \n            <div className=\\\"container mx-auto max-w-5xl p-4 py-10 md:p-12 page-fade-in\\\">\n                 {/* ... Header ... */}\n                \n                 {/* SECURITY CIRCUIT */}\n                <section id=\\\"security\\\">\n                     {/* ... */}\n                    <div className=\\\"space-y-2 divide-y divide-[#333]/50\\\">\n                        <Toggle \n                            checked={settings.mfaActive} onChange={(c) => handleSettingChange(\\\'mfaActive\\\', c)} \n                            label={<span className=\\\"font-heading uppercase text-sm\\\">MFA Management</span>}\n                            description=\\\"Mandatory for withdrawals and high-risk executions.\\\"\n                        />\n                         <Toggle \n                            checked={settings.highSecLogs} onChange={(c) => handleSettingChange(\\\'highSecLogs\\\', c)} \n                            label={<span className=\\\"font-heading uppercase text-sm\\\">Enable High-Security Access Logs</span>}\n                            description=\\\"Continuous capture of IP metadata and session vectors.\\\"\n                        />\n                        {/* ... more toggles with the same pattern */}\n                    </div>\n                </section>\n\n                {/* USER PREFERENCES */}\n                 <section id=\\\"preferences\\\">\n                     {/* ... */}\n                     <Toggle \n                        checked={!settings.audioMuted} onChange={handleAudioToggle} \n                        label={<span className=\\\"font-heading uppercase text-sm\\\">Tactical Audio Feedback</span>}\n                        description=\\\"Enable UI sound effects for clicks and notifications.\\\"\n                    />\n                    <select value={settings.language} onChange={(e) => handleSettingChange(\\\'language\\\', e.target.value)}>\n                        {/* ... options ... */}\n                    </select>\n                     {/* ... etc ... */}\n                 </section>\n\n                 {/* ... all other sections updated similarly ... */}\n            </div>\n        </>\n    );\n};\n